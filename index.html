<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H√†ng B√π X∆∞·ªüng A VIP PRO</title>
    <!-- Th∆∞ vi·ªán Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Th∆∞ vi·ªán JsBarcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6;
            /* NgƒÉn ch·∫∑n zoom lung tung tr√™n mobile khi ch·∫°m nhanh */
            touch-action: manipulation;
        }

        /* T√πy ch·ªânh cho Barcode Card */
        .barcode-card {
            background: white;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            /* Full width on mobile */
            break-inside: avoid;
            page-break-inside: avoid;
        }

        /* ƒê·∫£m b·∫£o SVG co gi√£n t·ªët nh∆∞ng kh√¥ng b·ªã b√≥p m√©o qu√° m·ª©c */
        svg {
            max-width: 100%;
            height: auto;
            display: block;
            /* Quan tr·ªçng: ƒê·ªÉ barcode kh√¥ng b·ªã scale nh·ªè qu√° m·ª©c khi width tƒÉng */
            min-width: 150px;
        }

        /* Khi ·ªü trong c·∫∑p barcode, cho ph√©p cu·ªôn ngang n·∫øu m√†n h√¨nh qu√° b√© thay v√¨ b√≥p barcode */
        .barcode-pair svg {
            flex-shrink: 0;
        }

        /* Input Styles cho Mobile: Ch·ªØ to, padding r·ªông ƒë·ªÉ d·ªÖ b·∫•m */
        input[type="text"],
        input[type="number"],
        textarea {
            font-size: 16px !important;
            /* NgƒÉn iOS t·ª± zoom */
        }

        /* Ch·∫ø ƒë·ªô in ·∫•n */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background-color: white;
                padding: 0;
            }

            .print-area {
                width: 100%;
                display: block;
            }

            .barcode-pair {
                border-bottom: 1px dashed #ccc;
                padding-bottom: 20px;
                margin-bottom: 20px;
                page-break-inside: avoid;
            }

            /* Khi in th√¨ b·ªè shadow v√† border ƒë·ªÉ ti·∫øt ki·ªám m·ª±c */
            .barcode-card,
            .barcode-pair {
                box-shadow: none;
                border: none;
            }
        }
    </style>
</head>

<body class="p-3 md:p-6">

    <!-- PH·∫¶N ƒêI·ªÄU KHI·ªÇN -->
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden mb-6 no-print">
        <div class="p-4 md:p-6 bg-blue-600 text-white">
            <h1 class="text-xl md:text-2xl font-bold">T·∫°o Barcode 128</h1>
            <p class="opacity-90 text-sm">C√¥ng c·ª• h·ªó tr·ª£ H√†ng B√π X∆∞·ªüng A VIP PRO</p>
        </div>

        <!-- Tabs to d·ªÖ b·∫•m -->
        <div class="flex border-b border-gray-200">
            <button onclick="switchTab('simple')" id="tab-simple"
                class="flex-1 py-4 text-center font-medium text-blue-600 border-b-4 border-blue-600 bg-blue-50 focus:outline-none transition-colors active:bg-blue-100">
                T·∫°o ƒê∆°n L·∫ª
            </button>
            <button onclick="switchTab('pair')" id="tab-pair"
                class="flex-1 py-4 text-center font-medium text-gray-500 hover:text-blue-600 hover:bg-gray-50 focus:outline-none transition-colors border-b-4 border-transparent active:bg-gray-100">
                T·∫°o Theo C·∫∑p
            </button>
        </div>

        <!-- LEGACY SCANNER MODE TOGGLE -->
        <div class="px-4 md:px-6 py-3 bg-gradient-to-r from-yellow-50 to-orange-50 border-y border-orange-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="text-2xl">üì±</div>
                    <div>
                        <div class="font-bold text-gray-800 text-sm">Ch·∫ø ƒê·ªô M√°y Scan C≈©</div>
                        <div class="text-xs text-gray-600">T·ªëi ∆∞u cho PDA/m√°y c≈© (VD: Zebra MC3200)</div>
                    </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="legacy-mode-toggle" class="sr-only peer" onchange="toggleLegacyMode()">
                    <div
                        class="w-14 h-8 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-orange-500">
                    </div>
                </label>
            </div>
            <div id="legacy-mode-info"
                class="hidden mt-2 text-xs text-orange-800 bg-orange-100 p-2 rounded border border-orange-300">
                ‚úì <strong>ƒê√£ b·∫≠t:</strong> Barcode to, r√µ h∆°n, d·ªÖ scan v·ªõi m√°y c≈©
            </div>
        </div>

        <div class="p-4 md:p-6">
            <!-- FORM: T·∫†O ƒê∆†N -->
            <div id="content-simple" class="block">
                <!-- Toggle Mode: Manual vs Auto -->
                <div class="flex gap-2 mb-4">
                    <button onclick="toggleSimpleMode('manual')" id="simple-mode-manual"
                        class="flex-1 py-2 text-center font-medium text-blue-600 border-2 border-blue-600 bg-blue-50 rounded-lg focus:outline-none transition-colors">
                        Nh·∫≠p Th·ªß C√¥ng
                    </button>
                    <button onclick="toggleSimpleMode('auto')" id="simple-mode-auto"
                        class="flex-1 py-2 text-center font-medium text-gray-500 border-2 border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none transition-colors">
                        T·ª± ƒê·ªông Li√™n Ti·∫øp
                    </button>
                </div>

                <!-- Manual Input Mode -->
                <div id="simple-manual-mode" class="block">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Nh·∫≠p danh s√°ch m√£ (M·ªói m√£ 1 d√≤ng):
                    </label>
                    <textarea id="simpleInput" rows="5"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                        placeholder="501231231450&#10;501231231451"></textarea>
                </div>

                <!-- Auto Generate Mode -->
                <div id="simple-auto-mode" class="hidden space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">M√£ B·∫Øt ƒê·∫ßu</label>
                        <input type="text" id="simpleAutoStart"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="VD: 501231231450">
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <label class="block text-gray-700 text-sm font-bold mb-1">S·ªë L∆∞·ª£ng</label>
                            <input type="number" id="simpleAutoCount"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                value="1" min="1">
                        </div>
                        <div class="flex-none pt-6">
                            <button onclick="adjustSimpleCount(1)"
                                class="bg-gray-200 p-3 rounded-lg font-bold text-gray-700 active:bg-gray-300">+</button>
                        </div>
                    </div>
                    <div class="p-3 bg-yellow-50 text-yellow-800 rounded text-sm border border-yellow-200">
                        H·ªá th·ªëng t·ª± ƒë·ªông tƒÉng s·ªë cu·ªëi cho c√°c m√£ ti·∫øp theo.
                    </div>
                </div>

                <button onclick="generateSimple()"
                    class="mt-4 w-full bg-blue-600 active:bg-blue-800 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition transform active:scale-95">
                    T·∫°o Barcode Ngay
                </button>
            </div>

            <!-- FORM: T·∫†O C·∫∂P -->
            <div id="content-pair" class="hidden">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">M√£ M·∫∑t Da (B·∫Øt ƒë·∫ßu)</label>
                        <input type="text" id="upperStart"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="VD: 50023001">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">M√£ ƒê·∫ø Gi√†y (B·∫Øt ƒë·∫ßu)</label>
                        <input type="text" id="soleStart"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="VD: 50023020">
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <label class="block text-gray-700 text-sm font-bold mb-1">S·ªë l∆∞·ª£ng Size</label>
                            <input type="number" id="sizeCount"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                value="1" min="1">
                        </div>
                        <div class="flex-none pt-6">
                            <!-- N√∫t tƒÉng gi·∫£m nhanh cho mobile -->
                            <button onclick="adjustSize(1)"
                                class="bg-gray-200 p-3 rounded-lg font-bold text-gray-700 active:bg-gray-300">+</button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-yellow-50 text-yellow-800 rounded text-sm border border-yellow-200">
                    H·ªá th·ªëng t·ª± ƒë·ªông tƒÉng s·ªë cu·ªëi cho c√°c size ti·∫øp theo.
                </div>

                <button onclick="generatePairs()"
                    class="mt-4 w-full bg-green-600 active:bg-green-800 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow transition transform active:scale-95">
                    T·∫°o Barcode C·∫∑p
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-3 gap-3 mt-6 pt-4 border-t border-gray-100">
                <button onclick="clearResults()"
                    class="flex items-center justify-center py-3 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium active:bg-gray-200">
                    X√≥a
                </button>
                <button onclick="activateScanMode()" id="scan-mode-btn"
                    class="flex items-center justify-center py-3 px-4 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-bold shadow active:bg-orange-800">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
                        </path>
                    </svg>
                    Scan
                </button>
                <button onclick="window.print()"
                    class="flex items-center justify-center py-3 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold shadow active:bg-purple-800">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
                        </path>
                    </svg>
                    In
                </button>
            </div>
        </div>
    </div>

    <!-- SCAN MODE INTERFACE -->
    <div id="scan-mode-container"
        class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden mb-6 no-print hidden">
        <div class="p-4 md:p-6 bg-orange-600 text-white">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-xl md:text-2xl font-bold">üîç Ch·∫ø ƒê·ªô Scan</h2>
                    <p class="opacity-90 text-sm">Scan t·ª´ng m√£ m·ªôt c√°ch d·ªÖ d√†ng</p>
                </div>
                <button onclick="exitScanMode()"
                    class="bg-white text-orange-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-100 active:bg-gray-200">
                    Tho√°t
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="px-4 md:px-6 pt-4">
            <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                <span>Ti·∫øn Tr√¨nh</span>
                <span id="scan-progress-text">0/0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div id="scan-progress-bar" class="bg-green-500 h-4 transition-all duration-300" style="width: 0%">
                </div>
            </div>
        </div>

        <!-- Current Item Display -->
        <div class="p-4 md:p-6">
            <div id="scan-current-display"
                class="bg-gray-50 rounded-lg p-6 min-h-[300px] flex flex-col items-center justify-center">
                <!-- Barcode will be injected here -->
            </div>

            <!-- Navigation Controls -->
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="scanPrevious()" id="scan-prev-btn"
                    class="py-3 px-4 border-2 border-gray-300 rounded-lg text-gray-700 font-bold hover:bg-gray-50 active:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚Üê Tr∆∞·ªõc
                </button>
                <button onclick="scanNext()" id="scan-next-btn"
                    class="py-3 px-4 border-2 border-gray-300 rounded-lg text-gray-700 font-bold hover:bg-gray-50 active:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Sau ‚Üí
                </button>
            </div>

            <!-- Mark as Scanned Button -->
            <button onclick="markAsScanned()" id="scan-mark-btn"
                class="mt-4 w-full bg-green-600 active:bg-green-800 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg shadow-lg transition transform active:scale-95 text-lg">
                ‚úì ƒê√£ Scan - Ti·∫øp Theo
            </button>
        </div>
    </div>

    <!-- KHU V·ª∞C HI·ªÇN TH·ªä K·∫æT QU·∫¢ -->
    <div id="result-area" class="max-w-4xl mx-auto print-area space-y-4 pb-10">
        <div id="placeholder" class="text-center text-gray-400 py-10 no-print italic">
            K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...
        </div>
    </div>

    <script>
        // --- GLOBAL SCAN MODE STATE ---
        let scanModeActive = false;
        let scanItems = [];
        let scanCurrentIndex = 0;
        let scannedItems = new Set();
        let currentScanType = 'simple'; // 'simple' or 'pair'

        // --- LEGACY SCANNER MODE ---
        let legacyModeEnabled = false;

        // Track last generation for auto-regenerate
        let lastGenerationType = null; // 'simple' or 'pair'
        let lastGenerationParams = null;

        // --- X·ª¨ L√ù GIAO DI·ªÜN ---
        function switchTab(tab) {
            const simpleBtn = document.getElementById('tab-simple');
            const pairBtn = document.getElementById('tab-pair');
            const simpleContent = document.getElementById('content-simple');
            const pairContent = document.getElementById('content-pair');

            if (tab === 'simple') {
                simpleContent.classList.remove('hidden');
                pairContent.classList.add('hidden');

                simpleBtn.className = 'flex-1 py-4 text-center font-medium text-blue-600 border-b-4 border-blue-600 bg-blue-50 focus:outline-none transition-colors';
                pairBtn.className = 'flex-1 py-4 text-center font-medium text-gray-500 hover:text-blue-600 hover:bg-gray-50 focus:outline-none transition-colors border-b-4 border-transparent';
            } else {
                simpleContent.classList.add('hidden');
                pairContent.classList.remove('hidden');

                pairBtn.className = 'flex-1 py-4 text-center font-medium text-blue-600 border-b-4 border-blue-600 bg-blue-50 focus:outline-none transition-colors';
                simpleBtn.className = 'flex-1 py-4 text-center font-medium text-gray-500 hover:text-blue-600 hover:bg-gray-50 focus:outline-none transition-colors border-b-4 border-transparent';
            }
        }

        // Toggle Legacy Scanner Mode
        function toggleLegacyMode() {
            legacyModeEnabled = document.getElementById('legacy-mode-toggle').checked;
            const infoDiv = document.getElementById('legacy-mode-info');

            if (legacyModeEnabled) {
                infoDiv.classList.remove('hidden');
            } else {
                infoDiv.classList.add('hidden');
            }

            // Auto-regenerate if barcodes already exist
            if (lastGenerationType && lastGenerationParams) {
                const resultArea = document.getElementById('result-area');
                const hasContent = !resultArea.querySelector('#placeholder');

                if (hasContent) {
                    // Regenerate with new settings
                    if (lastGenerationType === 'simple') {
                        generateSimpleWithParams(lastGenerationParams);
                    } else if (lastGenerationType === 'pair') {
                        generatePairsWithParams(lastGenerationParams);
                    }

                    // Show notification
                    showNotification(legacyModeEnabled ?
                        '‚úì ƒê√£ chuy·ªÉn sang Ch·∫ø ƒë·ªô M√°y C≈© - Barcode to h∆°n!' :
                        '‚úì ƒê√£ t·∫Øt Ch·∫ø ƒë·ªô M√°y C≈© - Barcode b√¨nh th∆∞·ªùng'
                    );
                }
            }
        }

        // Show temporary notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in font-bold';
            notification.innerHTML = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Toggle between manual and auto mode for simple codes
        function toggleSimpleMode(mode) {
            const manualBtn = document.getElementById('simple-mode-manual');
            const autoBtn = document.getElementById('simple-mode-auto');
            const manualContent = document.getElementById('simple-manual-mode');
            const autoContent = document.getElementById('simple-auto-mode');

            if (mode === 'manual') {
                manualContent.classList.remove('hidden');
                autoContent.classList.add('hidden');

                manualBtn.className = 'flex-1 py-2 text-center font-medium text-blue-600 border-2 border-blue-600 bg-blue-50 rounded-lg focus:outline-none transition-colors';
                autoBtn.className = 'flex-1 py-2 text-center font-medium text-gray-500 border-2 border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none transition-colors';
            } else {
                manualContent.classList.add('hidden');
                autoContent.classList.remove('hidden');

                autoBtn.className = 'flex-1 py-2 text-center font-medium text-blue-600 border-2 border-blue-600 bg-blue-50 rounded-lg focus:outline-none transition-colors';
                manualBtn.className = 'flex-1 py-2 text-center font-medium text-gray-500 border-2 border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none transition-colors';
            }
        }

        function adjustSize(amount) {
            const input = document.getElementById('sizeCount');
            let val = parseInt(input.value) || 0;
            val += amount;
            if (val < 1) val = 1;
            input.value = val;
        }

        function adjustSimpleCount(amount) {
            const input = document.getElementById('simpleAutoCount');
            let val = parseInt(input.value) || 0;
            val += amount;
            if (val < 1) val = 1;
            input.value = val;
        }

        function clearResults() {
            document.getElementById('result-area').innerHTML = '<div id="placeholder" class="text-center text-gray-400 py-10 no-print italic">K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>';
            // Scroll l·∫°i l√™n ƒë·∫ßu m·ªôt ch√∫t ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒë√£ x√≥a
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- C·∫§U H√åNH BARCODE ---
        function getBarcodeOptions() {
            if (legacyModeEnabled) {
                // Legacy mode: Optimized for older scanners
                return {
                    format: "CODE128",
                    lineColor: "#000",
                    width: 4,           // Thicker bars for better readability
                    height: 100,        // Taller for easier scanning
                    displayValue: true,
                    fontSize: 20,       // Larger font
                    margin: 20,         // More margin space
                    textMargin: 5
                };
            } else {
                // Normal mode: Compact and efficient
                return {
                    format: "CODE128",
                    lineColor: "#000",
                    width: 2,
                    height: 60,
                    displayValue: true,
                    fontSize: 16,
                    margin: 10
                };
            }
        }


        // --- LOGIC X·ª¨ L√ù M√É ---
        function incrementCode(codeStr, addValue) {
            if (/^\d+$/.test(codeStr)) {
                let num = BigInt(codeStr);
                let result = num + BigInt(addValue);
                return result.toString().padStart(codeStr.length, '0');
            } else {
                return codeStr + "-" + addValue;
            }
        }

        // --- T·∫†O ƒê∆†N ---
        function generateSimple() {
            const container = document.getElementById('result-area');
            container.innerHTML = '';

            // Check which mode is active
            const isAutoMode = !document.getElementById('simple-auto-mode').classList.contains('hidden');

            let codes = [];
            let params = { isAutoMode };

            if (isAutoMode) {
                // Auto-generate mode
                const startCode = document.getElementById('simpleAutoStart').value.trim();
                const count = parseInt(document.getElementById('simpleAutoCount').value);

                if (!startCode || !count || count < 1) {
                    alert("Vui l√≤ng nh·∫≠p M√£ B·∫Øt ƒê·∫ßu v√† S·ªë L∆∞·ª£ng!");
                    return;
                }

                params.startCode = startCode;
                params.count = count;

                // Generate consecutive codes
                for (let i = 0; i < count; i++) {
                    codes.push(incrementCode(startCode, i));
                }
            } else {
                // Manual mode
                const input = document.getElementById('simpleInput').value;

                if (!input.trim()) {
                    alert("B·∫°n ch∆∞a nh·∫≠p m√£ n√†o c·∫£!");
                    return;
                }

                params.inputText = input;

                const lines = input.split('\n');
                lines.forEach(line => {
                    const code = line.trim();
                    if (code) {
                        codes.push(code);
                    }
                });
            }

            if (codes.length === 0) {
                alert("Kh√¥ng c√≥ m√£ n√†o ƒë·ªÉ t·∫°o!");
                return;
            }

            // Save params for regeneration
            lastGenerationType = 'simple';
            lastGenerationParams = params;

            const grid = document.createElement('div');
            // Mobile: 1 c·ªôt, Tablet tr·ªü l√™n: 2 c·ªôt
            grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';

            codes.forEach(code => {
                const card = document.createElement('div');
                card.className = 'barcode-card shadow-sm';

                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");

                try {
                    JsBarcode(svg, code, getBarcodeOptions());
                    card.appendChild(svg);
                } catch (e) {
                    const err = document.createElement('div');
                    err.innerHTML = `<span class="text-red-500 font-bold">L·ªói m√£:</span> ${code}`;
                    card.appendChild(err);
                }
                grid.appendChild(card);
            });

            container.appendChild(grid);
            // T·ª± ƒë·ªông cu·ªôn xu·ªëng k·∫øt qu·∫£ tr√™n mobile
            setTimeout(() => {
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Helper function to regenerate simple barcodes with saved params
        function generateSimpleWithParams(params) {
            const container = document.getElementById('result-area');
            container.innerHTML = '';

            let codes = [];

            if (params.isAutoMode) {
                // Auto-generate mode
                for (let i = 0; i < params.count; i++) {
                    codes.push(incrementCode(params.startCode, i));
                }
            } else {
                // Manual mode
                const lines = params.inputText.split('\n');
                lines.forEach(line => {
                    const code = line.trim();
                    if (code) {
                        codes.push(code);
                    }
                });
            }

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';

            codes.forEach(code => {
                const card = document.createElement('div');
                card.className = 'barcode-card shadow-sm';

                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");

                try {
                    JsBarcode(svg, code, getBarcodeOptions());
                    card.appendChild(svg);
                } catch (e) {
                    const err = document.createElement('div');
                    err.innerHTML = `<span class="text-red-500 font-bold">L·ªói m√£:</span> ${code}`;
                    card.appendChild(err);
                }
                grid.appendChild(card);
            });

            container.appendChild(grid);
        }

        // --- T·∫†O C·∫∂P ---
        function generatePairs() {
            const startUpper = document.getElementById('upperStart').value.trim();
            const startSole = document.getElementById('soleStart').value.trim();
            const count = parseInt(document.getElementById('sizeCount').value);
            const container = document.getElementById('result-area');

            if (!startUpper || !startSole || !count || count < 1) {
                alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin (M√£ Da, M√£ ƒê·∫ø, S·ªë l∆∞·ª£ng).");
                return;
            }

            // Save params for regeneration
            lastGenerationType = 'pair';
            lastGenerationParams = {
                startUpper,
                startSole,
                count
            };

            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const currentUpper = incrementCode(startUpper, i);
                const currentSole = incrementCode(startSole, i);

                const pairRow = document.createElement('div');
                // Mobile: X·∫øp d·ªçc (col), Tablet: X·∫øp ngang (row)
                pairRow.className = 'barcode-pair flex flex-col md:flex-row items-center justify-center gap-6 p-4 bg-white rounded-lg shadow border border-gray-200 mb-4';

                // Wrapper Da
                const upperWrapper = document.createElement('div');
                upperWrapper.className = 'text-center w-full md:w-auto';
                const upperTitle = document.createElement('div');
                upperTitle.className = 'text-sm font-bold text-gray-500 mb-1 bg-gray-100 inline-block px-2 rounded';
                upperTitle.innerText = `Da - Size ${i + 1}`;
                const svgUpper = document.createElementNS("http://www.w3.org/2000/svg", "svg");

                // Wrapper ƒê·∫ø
                const soleWrapper = document.createElement('div');
                soleWrapper.className = 'text-center w-full md:w-auto';
                const soleTitle = document.createElement('div');
                soleTitle.className = 'text-sm font-bold text-gray-500 mb-1 bg-gray-100 inline-block px-2 rounded';
                soleTitle.innerText = `ƒê·∫ø - Size ${i + 1}`;
                const svgSole = document.createElementNS("http://www.w3.org/2000/svg", "svg");

                try {
                    JsBarcode(svgUpper, currentUpper, getBarcodeOptions());
                    JsBarcode(svgSole, currentSole, getBarcodeOptions());
                } catch (e) {
                    alert("M√£ kh√¥ng h·ª£p l·ªá ƒë·ªÉ t·∫°o Barcode 128");
                    return;
                }

                upperWrapper.appendChild(upperTitle);
                upperWrapper.appendChild(svgUpper);

                soleWrapper.appendChild(soleTitle);
                soleWrapper.appendChild(svgSole);

                pairRow.appendChild(upperWrapper);

                // K·∫ª ngang ph√¢n c√°ch tr√™n mobile, k·∫ª d·ªçc tr√™n PC
                const divider = document.createElement('div');
                divider.className = 'w-full h-px bg-gray-200 md:w-px md:h-24 md:bg-gray-300 mx-2';
                pairRow.appendChild(divider);

                pairRow.appendChild(soleWrapper);

                container.appendChild(pairRow);
            }

            // Cu·ªôn xu·ªëng xem k·∫øt qu·∫£
            setTimeout(() => {
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Helper function to regenerate pairs with saved params
        function generatePairsWithParams(params) {
            const { startUpper, startSole, count } = params;
            const container = document.getElementById('result-area');
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const currentUpper = incrementCode(startUpper, i);
                const currentSole = incrementCode(startSole, i);

                const pairRow = document.createElement('div');
                pairRow.className = 'barcode-pair flex flex-col md:flex-row items-center justify-center gap-6 p-4 bg-white rounded-lg shadow border border-gray-200 mb-4';

                // Wrapper Da
                const upperWrapper = document.createElement('div');
                upperWrapper.className = 'text-center w-full md:w-auto';
                const upperTitle = document.createElement('div');
                upperTitle.className = 'text-sm font-bold text-gray-500 mb-1 bg-gray-100 inline-block px-2 rounded';
                upperTitle.innerText = `Da - Size ${i + 1}`;
                const svgUpper = document.createElementNS("http://www.w3.org/2000/svg", "svg");

                // Wrapper ƒê·∫ø
                const soleWrapper = document.createElement('div');
                soleWrapper.className = 'text-center w-full md:w-auto';
                const soleTitle = document.createElement('div');
                soleTitle.className = 'text-sm font-bold text-gray-500 mb-1 bg-gray-100 inline-block px-2 rounded';
                soleTitle.innerText = `ƒê·∫ø - Size ${i + 1}`;
                const svgSole = document.createElementNS("http://www.w3.org/2000/svg", "svg");

                try {
                    JsBarcode(svgUpper, currentUpper, getBarcodeOptions());
                    JsBarcode(svgSole, currentSole, getBarcodeOptions());
                } catch (e) {
                    console.error("Error generating legacy barcode pair", e);
                    continue;
                }

                upperWrapper.appendChild(upperTitle);
                upperWrapper.appendChild(svgUpper);

                soleWrapper.appendChild(soleTitle);
                soleWrapper.appendChild(svgSole);

                pairRow.appendChild(upperWrapper);

                const divider = document.createElement('div');
                divider.className = 'w-full h-px bg-gray-200 md:w-px md:h-24 md:bg-gray-300 mx-2';
                pairRow.appendChild(divider);

                pairRow.appendChild(soleWrapper);

                container.appendChild(pairRow);
            }
        }

        // --- SCAN MODE FUNCTIONS ---
        function activateScanMode() {
            const resultArea = document.getElementById('result-area');

            // Check if there are any barcodes generated
            const simpleBarcodes = resultArea.querySelectorAll('.barcode-card');
            const pairBarcodes = resultArea.querySelectorAll('.barcode-pair');

            if (simpleBarcodes.length === 0 && pairBarcodes.length === 0) {
                alert("Vui l√≤ng t·∫°o barcode tr∆∞·ªõc khi v√†o ch·∫ø ƒë·ªô Scan!");
                return;
            }

            // Prepare scan items
            scanItems = [];
            scannedItems = new Set();

            if (pairBarcodes.length > 0) {
                // Pair mode
                currentScanType = 'pair';
                pairBarcodes.forEach((pair, index) => {
                    const upperSvg = pair.querySelectorAll('svg')[0];
                    const soleSvg = pair.querySelectorAll('svg')[1];
                    const upperTitle = pair.querySelectorAll('.text-sm')[0]?.innerText || `Da - ${index + 1}`;
                    const soleTitle = pair.querySelectorAll('.text-sm')[1]?.innerText || `ƒê·∫ø - ${index + 1}`;

                    // Extract values
                    const upperValue = upperSvg.getAttribute('jsbarcode-value') || upperSvg.textContent;
                    const soleValue = soleSvg.getAttribute('jsbarcode-value') || soleSvg.textContent;

                    scanItems.push({
                        index,
                        type: 'pair',
                        upperValue,
                        soleValue,
                        upperTitle,
                        soleTitle
                    });
                });
            } else {
                // Simple mode
                currentScanType = 'simple';
                simpleBarcodes.forEach((card, index) => {
                    const svg = card.querySelector('svg');
                    if (svg) {
                        const value = svg.getAttribute('jsbarcode-value') || svg.textContent;
                        scanItems.push({
                            index,
                            type: 'simple',
                            value
                        });
                    }
                });
            }

            if (scanItems.length === 0) {
                alert("Kh√¥ng t√¨m th·∫•y barcode h·ª£p l·ªá!");
                return;
            }

            // Activate scan mode
            scanModeActive = true;
            scanCurrentIndex = 0;

            // Show scan mode container
            document.getElementById('scan-mode-container').classList.remove('hidden');

            // Render first item
            renderScanItem();
            updateScanProgress();

            // Scroll to scan mode
            setTimeout(() => {
                document.getElementById('scan-mode-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function renderScanItem() {
            if (scanItems.length === 0) return;

            const display = document.getElementById('scan-current-display');
            const currentItem = scanItems[scanCurrentIndex];
            const isScanned = scannedItems.has(scanCurrentIndex);

            let html = '';

            if (currentItem.type === 'pair') {
                html = `
                    <div class="w-full">
                        <div class="text-center mb-4">
                            <span class="inline-block px-4 py-2 rounded-lg font-bold text-lg ${isScanned ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                ${isScanned ? '‚úì ƒê√£ Scan' : 'Ch∆∞a Scan'} - C·∫∑p ${scanCurrentIndex + 1}/${scanItems.length}
                            </span>
                        </div>
                        <div class="flex flex-col md:flex-row items-center justify-center gap-6">
                            <div class="text-center">
                                <div class="text-sm font-bold text-gray-500 mb-2">${currentItem.upperTitle}</div>
                                <svg id="scan-upper-svg"></svg>
                            </div>
                            <div class="w-full h-px bg-gray-300 md:w-px md:h-32"></div>
                            <div class="text-center">
                                <div class="text-sm font-bold text-gray-500 mb-2">${currentItem.soleTitle}</div>
                                <svg id="scan-sole-svg"></svg>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html = `
                    <div class="w-full">
                        <div class="text-center mb-4">
                            <span class="inline-block px-4 py-2 rounded-lg font-bold text-lg ${isScanned ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                ${isScanned ? '‚úì ƒê√£ Scan' : 'Ch∆∞a Scan'} - M√£ ${scanCurrentIndex + 1}/${scanItems.length}
                            </span>
                        </div>
                        <div class="flex justify-center">
                            <svg id="scan-simple-svg"></svg>
                        </div>
                    </div>
                `;
            }

            display.innerHTML = html;

            // Generate Barcodes dynamically
            try {
                if (currentItem.type === 'pair') {
                    JsBarcode("#scan-upper-svg", currentItem.upperValue, getBarcodeOptions());
                    JsBarcode("#scan-sole-svg", currentItem.soleValue, getBarcodeOptions());
                } else {
                    JsBarcode("#scan-simple-svg", currentItem.value, getBarcodeOptions());
                }
            } catch (e) {
                console.error("Error rendering scan barcode", e);
            }

            // Update button states
            document.getElementById('scan-prev-btn').disabled = scanCurrentIndex === 0;
            document.getElementById('scan-next-btn').disabled = scanCurrentIndex === scanItems.length - 1;

            // Update mark button text
            const markBtn = document.getElementById('scan-mark-btn');
            if (isScanned) {
                markBtn.className = 'mt-4 w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 px-4 rounded-lg shadow-lg transition text-lg';
                markBtn.innerHTML = 'B·ªè ƒê√°nh D·∫•u';
            } else {
                markBtn.className = 'mt-4 w-full bg-green-600 active:bg-green-800 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg shadow-lg transition transform active:scale-95 text-lg';
                markBtn.innerHTML = '‚úì ƒê√£ Scan - Ti·∫øp Theo';
            }
        }

        function updateScanProgress() {
            const scannedCount = scannedItems.size;
            const totalCount = scanItems.length;
            const percentage = totalCount > 0 ? (scannedCount / totalCount) * 100 : 0;

            document.getElementById('scan-progress-text').innerText = `${scannedCount}/${totalCount}`;
            document.getElementById('scan-progress-bar').style.width = `${percentage}%`;
        }

        function scanPrevious() {
            if (scanCurrentIndex > 0) {
                scanCurrentIndex--;
                renderScanItem();
            }
        }

        function scanNext() {
            if (scanCurrentIndex < scanItems.length - 1) {
                scanCurrentIndex++;
                renderScanItem();
            }
        }

        function markAsScanned() {
            const isScanned = scannedItems.has(scanCurrentIndex);

            if (isScanned) {
                // Unmark
                scannedItems.delete(scanCurrentIndex);
            } else {
                // Mark as scanned
                scannedItems.add(scanCurrentIndex);

                // Auto-advance to next if not last item
                if (scanCurrentIndex < scanItems.length - 1) {
                    setTimeout(() => {
                        scanNext();
                    }, 200);
                }
            }

            renderScanItem();
            updateScanProgress();
        }

        function exitScanMode() {
            scanModeActive = false;
            scanItems = [];
            scanCurrentIndex = 0;
            scannedItems = new Set();

            document.getElementById('scan-mode-container').classList.add('hidden');

            // Scroll back to control panel
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>

</html>